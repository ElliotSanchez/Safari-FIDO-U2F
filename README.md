# Safari FIDO U2F

**Adds FIDO U2F support to Safari.**

## Quick Start

To use the extension:

- Download [the latest release](https://github.com/Safari-FIDO-U2F/Safari-FIDO-U2F/releases)
- Run It
- Click `Open Safari Preferences`
- Enable the `Safari FIDO U2F Extension`

This extension requires *macOS 10.12* and later or macOS 10.11.5 when Safari 10 is installed.

## Does It Work With Site xyz.com?

This extension adds support for the high-level FIDO U2F Javascript API to Safari.

The FIDO U2F specification leaves it up to the browser to implement this API, and leaves individual sites
to work out if the API is present / supported.

Many sites are using [u2f-api.js](https://demo.yubico.com/js/u2f-api.js) (or a variation of it) to provide
cross-browser support of U2F. This extension should override that u2f-api implementation and work.

However, there are still websites that do not work properly - see [Problems](#problems) below.

The following sites should work out of the box:

- [Yubico Demo](https://demo.yubico.com/u2f)
- [Google Demo](https://crxjs-dot-u2fdemo.appspot.com)
- [AkiSec Demo](https://akisec.com/demo/)
- [Github Account Two-factor authentication](https://help.github.com/articles/configuring-two-factor-authentication-via-fido-u2f/)
- Fastmail

## Problems

Plenty of sites do not work yet.

There are two main reasons for this:

- The extension works by injecting code into to the page as it loads. Some sites perform their checks too early, before the injected code is present.

- Some sites assume that only Chrome supports U2F on the Mac, and won't even try to use U2F if they detect Safari. [Changing Safari's User-Agent to Chrome](http://www.howtogeek.com/211961/how-to-change-safaris-user-agent-in-os-x/) may make these sites work.


## Technical Details

This extension uses the [Safari App Extensions](https://developer.apple.com/library/prerelease/content/documentation/NetworkingInternetWeb/Conceptual/SafariAppExtension_PG/index.html#//apple_ref/doc/uid/TP40017319-CH15-SW1) API introduced in Safari 10, which allows a Safari extension to be built using native code, and embedded in another app.

The native part uses [libu2f-host](https://github.com/Yubico/libu2f-host) as the backend.

Only the high-level JavaScript API is implemented for now: `register` and `sign` (see [FIDO U2F Javascript API Specification](https://fidoalliance.org/specs/fido-u2f-v1.0-nfc-bt-amendment-20150514/fido-u2f-javascript-api.html)). Both the API 1.1 and API 1.0 specifications are supported.

The extension works by setting `window.u2f` to an object which implements the FIDO javascript API.

This is accomplished via two scripts. A small `bridge.js` script is loaded automatically by the extension. This script can receive messages sent to `window`, but can't directly set properties on it, so we use it to do three things:

- listen for `DOMContentLoaded`, and use it to inject `u2f.js` into the document
- listen for messages generated by `u2f.js`, and pass them on to the native code which implements the U2F support
- listen for messages from the native code and pass them back to `u2f.js` for processing

The meat of the implementation is in `u2f.js`, which is injected into the document when the `DOMContentLoaded` event fires.

If the page had already set `window.u2f`, we merge our implementation into it, rather than completely replacing it, which means that any custom properties on it should be preserved.

As mentioned in [problems](#problems) above, the fact that we have to wait for `DOMContentLoaded` before injecting the `u2f` object can cause timing problems. If a page has code which decides whether to enable U2F support based on whether `window.u2f` is present, it's possible that it will run too early.

There doesn't appear to be much we can do about this. If anyone knows of a mechanism for injecting our code earlier, please [let us know](https://github.com/Safari-FIDO-U2F/Safari-FIDO-U2F/issues)!



## To Build With Xcode

- Clone this project
- Open Xcode workspace and select the scheme `Safari FIDO U2F`
- Extensions must be code signed. To build locally, you will need to adjust the `Development Team` setting of both targets to a team that you have Mac Developer certificates for
- Choose `Run` from the `Product` menu.
- Xcode should build & launch the small app. You can then enable the extension from within Safari.

## Dependencies

This plugin makes use of the following:

- hidapi: https://github.com/signal11/hidapi.git
- json-c: https://github.com/json-c/json-c.git
- u2f-host: https://github.com/Yubico/libu2f-host.git

For the sake of simplicity, compiled binaries for all three are committed to this repo.

The source for all three is available in the github repos above.

If you wish to build the libraries locally instead, you can do so using Homebrew, with `brew install hidapi json-c libu2f-host`.

## Disclaimer

The authors of this extension are not security, cryptography or javascript experts.

This extension is still experimental, and use of it is entirely at your own risk!

All feedback and other contributions welcomed.

In particular, please [tell us about sites that do / don't work](https://github.com/Safari-FIDO-U2F/Safari-FIDO-U2F/issues)! Please also consider contacting the owners of those sites to make them aware of this extension, so that we can work together to fix any problems.
